# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ë–£–§–ï–†–ò–ó–ê–¶–ò–ò WEBSOCKET

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

```
[WS] Client 0 buffer full, dropping frames
```

–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ —Ñ—Ä–µ–π–º—ã –∏–∑-–∑–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è TCP –±—É—Ñ–µ—Ä–æ–≤ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É—Ñ–µ—Ä–æ–≤

### 1. –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `availableForWrite()`

**–ë—ã–ª–æ:**

```cpp
if (wsClients_[i].availableForWrite() > 1024) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –Ω–µ –ø–æ–ª–Ω—ã–π
    sendFrame();
} else {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä - –±—É—Ñ–µ—Ä –ø–æ–ª–Ω—ã–π
    Serial.println("buffer full, dropping frames");
}
```

**–°—Ç–∞–ª–æ:**

```cpp
// –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê - –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞—Ç—å —Ñ—Ä–µ–π–º
// –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º availableForWrite() - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
if (sendWebSocketBinaryFrameSafe(wsClients_[i], fb->buf, fb->len)) {
    successful_sends++;
    frameSkipCount_[i] = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
} else {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
    wsClients_[i].flush();
    delay(1);
    sendWebSocketBinaryFrameSafe(wsClients_[i], fb->buf, fb->len);
}
```

### 2. –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ TCP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```cpp
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
wsClients_[slot].setNoDelay(true);    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º Nagle
wsClients_[slot].setTimeout(1);       // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
```

### 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–æ–≤

```cpp
// –í —Ü–∏–∫–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
for (int i = 0; i < MAX_CLIENTS; i++) {
    if (wsConnected_[i] && wsClients_[i].connected()) {
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ë–£–§–ï–†–ê
        wsClients_[i].flush();

        // –û—Å—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞...
    }
}
```

### 4. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫

```cpp
bool WebSocketServer::sendWebSocketBinaryFrameSafe(WiFiClient& client, const uint8_t* data, size_t len) {
    // NO BUFFER CHECKING - JUST SEND IMMEDIATELY

    // –°–æ–∑–¥–∞–µ–º WebSocket –∑–∞–≥–æ–ª–æ–≤–æ–∫
    uint8_t header[10];
    // ... –∑–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ ...

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫
    client.write(header, headerLen);
    client.write(data, len);
    client.flush();              // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

    return true; // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true
}
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ë—ã–ª–æ:

- ‚ùå –ö–∞–¥—Ä—ã –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É—Ñ–µ—Ä–∞
- ‚ùå –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞–ª–∏ –ø—Ä–µ—Ä—ã–≤–∏—Å—Ç–æ–µ –≤–∏–¥–µ–æ
- ‚ùå –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ "buffer full, dropping frames"

### –°—Ç–∞–ª–æ:

- ‚úÖ –ö–∞–¥—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –í–°–ï–ì–î–ê –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –±—É—Ñ–µ—Ä–∞
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –ø–ª–∞–≤–Ω–æ–µ –≤–∏–¥–µ–æ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
- ‚úÖ TCP –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ù–æ–≤—ã–µ –ª–æ–≥–∏ –≤–º–µ—Å—Ç–æ "buffer full":

```
[WS] Client 0: FORCE sending frame (buffer ignored)
[WS] WebSocket client 0 connected with FORCE_SEND mode
ESP32-S3 Camera Ready - FORCE SEND MODE - NO BUFFER LIMITS
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **TCP_NODELAY** - –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
2. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π timeout** - –Ω–µ –∂–¥–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞
3. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π flush()** - –æ—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
4. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ availableForWrite()** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–≥–¥–∞

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **FPS**: –°—Ç–∞–±–∏–ª—å–Ω—ã–µ 30 FPS –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–ª–∞–≥–æ–¥–∞—Ä—è TCP_NODELAY
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ë—É—Ñ–µ—Ä—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è—é—Ç—Å—è
- **–ö–∞—á–µ—Å—Ç–≤–æ**: –í—Å–µ –∫–∞–¥—Ä—ã –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É

---

**–ò—Ç–æ–≥:** –ö–ª–∏–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞—é—Ç –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è TCP –±—É—Ñ–µ—Ä–æ–≤! üéâ
