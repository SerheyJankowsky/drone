# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ô WEBSOCKET –ü–†–ò –†–ï–ó–ö–û–ô –°–ú–ï–ù–ï –ö–ê–†–¢–ò–ù–ö–ò

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

```
WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–∑–∫–æ–π —Å–º–µ–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–∏ —Ä–µ–∑–∫–æ–π —Å–º–µ–Ω–µ —Å—Ü–µ–Ω—ã —Ä–∞–∑–º–µ—Ä JPEG –∫–∞–¥—Ä–∞ —Ä–µ–∑–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (—Å 5KB –¥–æ 50KB+), —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç:

- –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ TCP –±—É—Ñ–µ—Ä–æ–≤
- –¢–∞–π–º–∞—É—Ç—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –±–æ–ª—å—à–∏—Ö –±–ª–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –û–±—Ä—ã–≤ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ß–∞–Ω–∫–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ + –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ

### 1. –ß–∞–Ω–∫–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–æ–ª—å—à–∏—Ö –∫–∞–¥—Ä–æ–≤

**WebSocket —Å–µ—Ä–≤–µ—Ä** (`src/ws/websocket_server.cpp`):

```cpp
// –ß–ê–ù–ö–û–í–ê–Ø –û–¢–ü–†–ê–í–ö–ê –ë–û–õ–¨–®–ò–• –ö–ê–î–†–û–í –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞–∑—Ä—ã–≤–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
const size_t CHUNK_SIZE = 4096; // 4KB —á–∞–Ω–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

if (len > CHUNK_SIZE) {
    // –ë–æ–ª—å—à–æ–π –∫–∞–¥—Ä - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ —á–∞—Å—Ç—è–º
    size_t offset = 0;
    while (offset < len) {
        size_t chunk = std::min(CHUNK_SIZE, len - offset);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞–Ω–∫
        size_t written = client.write(data + offset, chunk);
        if (written != chunk) {
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ flush
            client.flush();
            delayMicroseconds(100); // –ú–∏–∫—Ä–æ–∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ TCP
            written = client.write(data + offset, chunk);
        }

        offset += written;

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π flush –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–∞–¥—Ä–æ–≤
        if (offset % (CHUNK_SIZE * 4) == 0) {
            client.flush();
            delayMicroseconds(50);
        }
    }
} else {
    // –ú–∞–ª–µ–Ω—å–∫–∏–π –∫–∞–¥—Ä - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
    client.write(data, len);
}
```

### 2. –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –∫–∞–º–µ—Ä—ã

**–ö–∞–º–µ—Ä–∞** (`src/camera/ov2640.cpp`):

```cpp
// –ü–†–û–í–ï–†–ö–ê –†–ê–ó–ú–ï–†–ê –ö–ê–î–†–ê –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞–∑—Ä—ã–≤–æ–≤ WebSocket
const size_t MAX_SAFE_FRAME_SIZE = 32768; // 32KB –º–∞–∫—Å–∏–º—É–º –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

if (fb->len > MAX_SAFE_FRAME_SIZE) {
    ESP_LOGW(TAG, "Large frame detected: %zu bytes (max safe: %zu)", fb->len, MAX_SAFE_FRAME_SIZE);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–¥—Ä –∏ –ø—Ä–æ–±—É–µ–º —É–≤–µ–ª–∏—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ
    esp_camera_fb_return(fb);

    // –í—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ JPEG (–±–æ–ª—å—à–µ —Å–∂–∞—Ç–∏–µ)
    sensor_t* sensor = esp_camera_sensor_get();
    if (sensor) {
        int current_quality = sensor->status.quality;
        if (current_quality < 25) { // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∂–∞—Ç–∏–µ
            sensor->set_quality(sensor, current_quality + 5);
            ESP_LOGI(TAG, "Increased JPEG compression to quality %d", current_quality + 5);
        }
    }

    // –î–µ–ª–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞—Ö–≤–∞—Ç —Å –±–æ–ª—å—à–∏–º —Å–∂–∞—Ç–∏–µ–º
    fb = esp_camera_fb_get();
    ESP_LOGI(TAG, "Recompressed frame size: %zu bytes", fb->len);
}
```

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π

```cpp
if (!wsClients_[i].connected()) {
    Serial.printf("[WS] ‚ö†Ô∏è  Client %d disconnected (likely due to large frame)\n", i);
    Serial.printf("[WS] üìä Frames skipped before disconnect: %d\n", frameSkipCount_[i]);
    Serial.printf("[WS] üîÑ Slot %d is now available for reconnection\n", i);

    wsConnected_[i] = false;
    wsClients_[i].stop();
    frameSkipCount_[i] = 0;
    lastPingTime_[i] = 0;
}
```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö (–º–∞–ª–µ–Ω—å–∫–∏–µ –∫–∞–¥—Ä—ã):

1. ‚úÖ –ö–∞–¥—Ä < 4KB ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É —Ü–µ–ª–∏–∫–æ–º
2. ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ
3. ‚úÖ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü—Ä–∏ —Ä–µ–∑–∫–æ–π —Å–º–µ–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–±–æ–ª—å—à–∏–µ –∫–∞–¥—Ä—ã):

1. üì∑ **–ö–∞–º–µ—Ä–∞:** –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∫–∞–¥—Ä > 32KB
2. üîÑ **–ö–∞–º–µ—Ä–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∂–∞—Ç–∏–µ JPEG
3. üì∑ **–ö–∞–º–µ—Ä–∞:** –ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–¥—Ä —Å –º–µ–Ω—å—à–∏–º —Ä–∞–∑–º–µ—Ä–æ–º
4. üì¶ **WebSocket:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–¥—Ä —á–∞–Ω–∫–∞–º–∏ –ø–æ 4KB
5. ‚ö° **WebSocket:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ flush() –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
6. ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º

## üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä                 | –ó–Ω–∞—á–µ–Ω–∏–µ    | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                           |
| ------------------------ | ----------- | ------------------------------------ |
| `CHUNK_SIZE`             | 4096 bytes  | –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–∞–¥—Ä–æ–≤      |
| `MAX_SAFE_FRAME_SIZE`    | 32768 bytes | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ –±–µ–∑ —á–∞–Ω–∫–æ–≤ |
| `delayMicroseconds(100)` | 100Œºs       | –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è TCP –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö         |
| `flush() –ø–µ—Ä–∏–æ–¥`         | –∫–∞–∂–¥—ã–µ 16KB | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞   |

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∫–∞–¥—Ä–∞—Ö:

```
[OV2640] Large frame detected: 45823 bytes (max safe: 32768)
[OV2640] Increased JPEG compression to quality 25
[OV2640] Recompressed frame size: 28456 bytes
[WS] Sending 28456 bytes in chunks of 4096
```

### –õ–æ–≥–∏ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏:

```
[WS] ‚ö†Ô∏è  Client 0 disconnected (likely due to large frame)
[WS] üìä Frames skipped before disconnect: 3
[WS] üîÑ Slot 0 is now available for reconnection
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ë—ã–ª–æ:

- ‚ùå WebSocket –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–∑–∫–æ–π —Å–º–µ–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
- ‚ùå –ë–æ–ª—å—à–∏–µ JPEG –∫–∞–¥—Ä—ã (50KB+) –≤—ã–∑—ã–≤–∞—é—Ç —Ç–∞–π–º–∞—É—Ç—ã
- ‚ùå –ö–ª–∏–µ–Ω—Ç—ã —Ç–µ—Ä—è—é—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

### –°—Ç–∞–ª–æ:

- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –ª—é–±—ã—Ö —Å—Ü–µ–Ω–∞—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –±–æ–ª—å—à–∏—Ö –∫–∞–¥—Ä–æ–≤
- ‚úÖ –ß–∞–Ω–∫–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–¥–∫–∏—Ö –æ–±—Ä—ã–≤–∞—Ö
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

**–ò—Ç–æ–≥:** WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å—Ç–∞–±–∏–ª—å–Ω—ã –¥–∞–∂–µ –ø—Ä–∏ —Ä–µ–∑–∫–∏—Ö —Å–º–µ–Ω–∞—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏! üéØ
